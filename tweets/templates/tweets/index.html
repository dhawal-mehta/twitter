{% extends 'tweets/base.html' %}
{% block content %}
<div class="row">
    <div class="col text-center">
        <h1>Welcome to twitter</h1>
    </div>
</div>

<div class="row mb-4">
    <div class='col-md-4 mx-auto col-10'>
        <form class="form" id="tweetCreateForm" method="POST" action="/create/">
            {% csrf_token %}
            <input type="hidden" value='/' name='next' />
            <textarea required="required" class='form-control' name='content' placeholder="What's happening?"></textarea>
            <button type="submit" class="btn btn-primary">Tweet</button>
        </form>
    </div>
</div>


<div id="tweets" class="row">Loading...</div>

<script>
const tweetsCreateFormEl = document.getElementById("tweetCreateForm")
const tweetsEl = document.getElementById("tweets")
    // tweetsElement.innerHTML = "Loading..."

tweetsCreateFormEl.addEventListener("submit", handleFormSubmit)


function handleFormSubmit(event){
    event.preventDefault()
    console.log(event) 
    form = event.target
    const myFormData = new FormData(form)
    const url = form.getAttribute("action")
    const method = form.getAttribute("method")
    // console.log(endpoint, method)

    // console.log(form.content.value)
    // console.log( myFormData.get("content") )
    const xhr = new XMLHttpRequest()
    // const responseType = "json"

    // xhr.responseType = responseType
    xhr.open(method, url)
    xhr.setRequestHeader("HTTP_X_REQUESTED_WITH", "XMLHttpRequest")
    xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest")


    xhr.onload = function(){
        // console.log( xhr.response )
        // const tweets = xhr.response.response
        // console.log(xhr.status)
        if (xhr.status === 201){
            const newTweet = JSON.parse(xhr.response)            
            const origHTML = tweetsEl.innerHTML
            const newTweetEl = formatTweetElement(newTweet) 
            const newHTML = newTweetEl + origHTML
            tweetsEl.innerHTML = newHTML
            form.reset()

        }
        else if(xhr.status === 400){

            const errorJSON = JSON.parse(xhr.response)
            const errorMsg =  errorJSON.content
            alert(errorMsg)
            // form.reset()
        }
        else{
            alert("Some error occurred please try again later.")
        }
    }

    
    xhr.send(myFormData)
}

function loadTweets(tweetsElement){
    const xhr = new XMLHttpRequest()
    const method = 'GET'
    const url = "/tweets/"
    const responseType = "json"

    xhr.responseType = responseType
    xhr.open(method, url)

    xhr.onload = function(){
        // console.log( xhr.response )
        // const tweets = xhr.response.response
        const serverResponse = xhr.response
        var listedItems = serverResponse.response
        var finalTweetsStr = ""
        for (var i=0;i<listedItems.length;i++){
            // console.log(listedItems[i])
            // var currentItems =  "<div><h2>"+ listedItems[i].id  +"</h2>" + "<p>" +  listedItems[i].content  + "</p></div>"
            finalTweetsStr += formatTweetElement(listedItems[i])
        }
        
        tweetsElement.innerHTML = finalTweetsStr

    }
    
    xhr.send()
} 

loadTweets(tweetsEl)

function handleDidLike(tweet_id, currentCount){

    // console.log(tweet_id, currentCount)

}

function likeBtn(tweet){
    return "<button class='btn btn-primary' onclick=handleDidLike(" + tweet.id + "," +  tweet.likes + ")>"+ tweet.likes +" Likes</button>"
}

function  formatTweetElement(tweet){
    var currentItems =  "<div class='mb-4 col-12 border rounded p-3' id='"+ tweet.id +"'>" + "<p>" +  tweet.content  + "</p><div >" + likeBtn(tweet) +"</div></div>"
    return currentItems
}

 

</script>
{% endblock %}